name: Auto-approve

# This workflow auto-approves PRs when the repository owner comments "stamp pls".
# 
# IMPORTANT: This requires a Personal Access Token (PAT) to be set up as a repository secret named AUTO_APPROVER_PAT_TOKEN.
# The PAT must have 'repo' scope and should ideally belong to a dedicated bot account.
# 
# Why PAT is needed:
# GitHub's GITHUB_TOKEN has a security restriction that prevents it from approving pull requests
# in workflows triggered by pull_request or pull_request_target events in some repository configurations.
# Using a PAT from a separate account (like a bot) bypasses this restriction.
#
# Setup instructions:
# 1. Create a GitHub account for a bot user (or use an existing bot account)
# 2. Generate a PAT with 'repo' scope for that account
# 3. Add the PAT as a repository secret named AUTO_APPROVER_PAT_TOKEN in Settings > Secrets and variables > Actions
#
# Usage:
# Comment "stamp pls" on a pull request to trigger auto-approval.

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    environment: auto_approve
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == github.repository_owner &&
      contains(github.event.comment.body, 'stamp pls')
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5c7944e73c4c2a096b17a9cb74d65b6c2bbafbde # v2.9.1
        with:
          egress-policy: audit

      - name: Auto-approve PR
        uses: hmarr/auto-approve-action@b40d6c9ed2371bb2d980c6adcb4396a3a3e79f0d # v4.0.0
        with:
          github-token: ${{ secrets.AUTO_APPROVER_PAT_TOKEN }}
          pull-request-number: ${{ github.event.issue.number }}
