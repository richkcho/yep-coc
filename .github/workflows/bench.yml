name: Manual PR Benchmarks

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number to benchmark'
        required: true
        type: number
      runner_label:
        description: 'Label for the self-hosted benchmark runner (e.g. highmem-x86, perf-arm)'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  CARGO_TARGET_DIR: ${{ github.workspace }}/.bench-target

jobs:
  benchmark:
    name: Bench PR #${{ inputs.pr_number }}
    runs-on: [self-hosted, '${{ inputs.runner_label }}']

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Comment benchmark start on PR
        id: progress-comment
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const prNumber = Number('${{ inputs.pr_number }}');
            const body = `Benchmark run started on runner label \`${{ inputs.runner_label }}\`...`;
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
            core.setOutput('comment_id', comment.id);

      - name: Checkout PR head
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: refs/pull/${{ inputs.pr_number }}/head
          fetch-depth: 0

      - name: Checkout main for baseline
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: main
          path: main-baseline
          fetch-depth: 0

      - name: Record main commit
        id: main_sha
        run: echo "sha=$(git -C main-baseline rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Update to latest stable Rust
        run: rustup update stable

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: bench-${{ inputs.runner_label }}
          workspaces: |
            .
            main-baseline
          cache-on-failure: true

      - name: Restore cached main baseline measurements
        id: baseline-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ env.CARGO_TARGET_DIR }}/criterion
          key: criterion-main-${{ inputs.runner_label }}-${{ steps.main_sha.outputs.sha }}

      - name: Run baseline on main (only if missing)
        if: steps.baseline-cache.outputs.cache-hit != 'true'
        working-directory: main-baseline
        run: cargo bench --bench spsc-throughput -- --save-baseline main

      - name: Run benchmarks for PR against main baseline
        run: cargo bench --bench spsc-throughput -- --baseline main

      - name: Upload criterion reports
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: pr-${{ inputs.pr_number }}-bench-${{ github.run_id }}
          path: ${{ env.CARGO_TARGET_DIR }}/criterion

      - name: Comment benchmark artifact on PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const prNumber = Number('${{ inputs.pr_number }}');
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactName = `pr-${prNumber}-bench-${context.runId}`;
            const body = [
              `Benchmark run completed for PR #${prNumber}.`,
              ``,
              `- Run: ${runUrl}`,
              `- Artifact: ${artifactName} (reports + baseline/compare data)`
            ].join('\n');

            const commentId = "${{ steps.progress-comment.outputs.comment_id }}";
            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }
